(()=>{"use strict";var e,t={429:(e,t,s)=>{var a=s(225);const n=e=>{const t=a.parse(e);return new a.Component(t).getAllSubcomponents("vevent").map((e=>{const t=new a.Event(e);return{title:t.summary,dueDate:t.startDate.toJSDate(),courseId:t.uid.split("_")[0],assignmentId:t.uid.split("_")[1]}}))},r=(e,t)=>{const s=(e.dueDate.getTime()-Date.now())/864e5;return Math.max(0,10-s)*t.dueDateWeight};var i;!function(e){e.ERROR="ERROR",e.WARN="WARN",e.INFO="INFO",e.DEBUG="DEBUG"}(i||(i={}));class o{constructor(){this.cleanOldLogs()}static getInstance(){return o.instance||(o.instance=new o),o.instance}async log(e,t,s){const a={timestamp:(new Date).toISOString(),level:e,message:t,data:s,stack:Error().stack};await this.saveLogs(a),e===i.ERROR&&this.notifyError(a)}async saveLogs(e){const{logs:t=[]}=await chrome.storage.local.get("logs");t.push(e),t.length>o.MAX_LOGS&&t.splice(0,t.length-o.MAX_LOGS),await chrome.storage.local.set({logs:t})}async cleanOldLogs(){const{logs:e=[]}=await chrome.storage.local.get("logs"),t=new Date;t.setDate(t.getDate()-30);const s=e.filter((e=>new Date(e.timestamp)>t));await chrome.storage.local.set({logs:s})}notifyError(e){chrome.notifications.create({type:"basic",iconUrl:"icons/icon128.png",title:"CanvasPal Error",message:e.message,priority:2})}async getLogs(e){const{logs:t=[]}=await chrome.storage.local.get("logs");return e?t.filter((t=>t.level===e)):t}}o.MAX_LOGS=1e3;const c=o.getInstance();class l{constructor(){this.gradeData={},this.lastSyncTime=0,this.initialize()}async initialize(){const e=await chrome.storage.local.get(null),t=Object.entries(e);for(const[e,s]of t)if(e.startsWith("grades_")){const t=e.replace("grades_","");this.gradeData[t]=s}chrome.runtime.onInstalled.addListener((()=>{this.startPeriodicSync()})),this.startPeriodicSync(),chrome.runtime.onMessage.addListener(((e,t,s)=>"GET_ASSIGNMENTS"===e.type?(this.fetchAndProcessAssignments().then((e=>s(e))).catch((e=>s({error:e.message}))),!0):"fetchAssignments"===e.type?(this.fetchAndProcessAssignments().then(s).catch((e=>s({error:e.message}))),!0):"gradeData"===e.type?(this.handleGradeData(e.data),s({success:!0}),!0):"forceSync"===e.type?(this.performSync().then((()=>s({success:!0}))).catch((e=>s({error:e.message}))),!0):void 0))}async fetchCalendarData(e){const t=await fetch(e),s=await t.text();return n(s)}handleGradeData(e){this.gradeData[e.courseName]=e,chrome.storage.local.set({[`grades_${e.courseName}`]:e})}startPeriodicSync(){this.syncIntervalId&&(window.clearInterval(this.syncIntervalId),this.syncIntervalId=void 0),this.retryTimeoutId&&(window.clearTimeout(this.retryTimeoutId),this.retryTimeoutId=void 0),this.performSync();const e=window.setInterval((()=>{this.performSync()}),l.SYNC_INTERVAL);this.syncIntervalId=e}async performSync(){try{const e=Date.now();if(e-this.lastSyncTime<6e4)return;await this.fetchAndProcessAssignments(),this.lastSyncTime=e,await c.log(i.INFO,"Sync completed successfully"),chrome.runtime.sendMessage({type:"syncComplete",timestamp:e})}catch(e){await c.log(i.ERROR,"Sync failed",e),console.error("Sync failed:",e);const t=window.setTimeout((()=>{this.performSync()}),l.RETRY_INTERVAL);this.retryTimeoutId=t,chrome.runtime.sendMessage({type:"syncError",error:e instanceof Error?e.message:"Unknown error"})}}async fetchAndProcessAssignments(){const{icalUrl:e}=await chrome.storage.sync.get("icalUrl");if(!e)throw new Error("iCalendar URL not set");try{const t=await fetch(e),s=await t.text(),a=this.parseICalData(s);return this.enrichAssignmentsWithGrades(a)}catch(e){throw console.error("Failed to fetch or parse iCal data:",e),new Error("Failed to fetch assignments")}}enrichAssignmentsWithGrades(e){return e.map((e=>Object.assign(Object.assign({},e),this.findGradeInfo(e))))}findGradeInfo(e){const t=this.gradeData[e.courseId];if(!t)return{};const s=t.assignments.find((t=>t.name.toLowerCase()===e.title.toLowerCase()));return s?{gradeWeight:s.weight,pointsPossible:s.pointsPossible,currentScore:s.points}:{}}parseICalData(e){return n(e).map((e=>Object.assign(Object.assign({},e),{courseId:this.extractCourseId(e.courseId)})))}extractCourseId(e){const t=e.match(/Course: (.*?)(?:\n|$)/);return t?t[1]:"Unknown Course"}}l.SYNC_INTERVAL=18e5,l.RETRY_INTERVAL=3e5,new l,chrome.runtime.onInstalled.addListener((()=>{chrome.storage.local.set({calendarUrl:"",priorities:{dueDate:.4,gradeWeight:.3,gradeImpact:.3}})})),chrome.alarms.create("sync",{periodInMinutes:30}),chrome.alarms.onAlarm.addListener((async e=>{if("sync"===e.name)try{const{calendarUrl:e}=await chrome.storage.local.get("calendarUrl");if(e){const t=await n(e),s=await async function(e){const{priorities:t}=await chrome.storage.local.get("priorities");return e.map((e=>Object.assign(Object.assign({},e),{priority:r(e,t)})))}(t);await chrome.storage.local.set({assignments:s})}}catch(e){console.error("Sync failed:",e)}}));const g=new class{constructor(){this.settings={feedUrl:"",refreshInterval:30},this.assignments=[],this.init()}async init(){await this.loadSettings(),this.setupPeriodicSync(),this.setupMessageListeners()}async loadSettings(){const e=await chrome.storage.local.get("settings");e.settings&&(this.settings=e.settings)}setupMessageListeners(){chrome.runtime.onMessage.addListener(((e,t,s)=>{switch(e.type){case"GET_ASSIGNMENTS":return this.getAssignments().then(s),!0;case"UPDATE_SETTINGS":return this.updateSettings(e.settings).then(s),!0;case"UPDATE_COMPLETION":return this.updateAssignmentCompletion(e.assignmentId,e.completed).then((()=>s({success:!0}))).catch((e=>s({error:e.message}))),!0}}))}setupPeriodicSync(){setInterval((()=>{this.syncData()}),60*this.settings.refreshInterval*1e3)}async syncData(){try{if(!this.settings.feedUrl)return;const e=await fetch(this.settings.feedUrl),t=await e.text(),s=await n(t);this.assignments=s.map((e=>({id:`${e.courseId}-${e.title}-${e.dueDate.getTime()}`,title:e.title,dueDate:e.dueDate,course:e.courseId||"Unknown",priorityScore:this.calculatePriority(e),completed:!1}))),await this.saveAssignments(this.assignments),chrome.runtime.sendMessage({type:"SYNC_COMPLETE"})}catch(e){console.error("Sync failed:",e),chrome.runtime.sendMessage({type:"SYNC_ERROR",error:e})}}calculatePriority(e){const t=new Date,s=new Date(e.dueDate).getTime()-t.getTime();return Math.max(0,Math.min(1,1-s/6048e5))}async saveAssignments(e){await chrome.storage.local.set({assignments:e})}async getAssignments(){return(await chrome.storage.local.get("assignments")).assignments||[]}async updateSettings(e){this.settings=Object.assign(Object.assign({},this.settings),e),await chrome.storage.local.set({settings:this.settings}),await this.syncData()}async updateAssignmentCompletion(e,t){const s=(await this.getAssignments()).map((s=>s.id===e?Object.assign(Object.assign({},s),{completed:t}):s));await this.saveAssignments(s),chrome.runtime.sendMessage({type:"ASSIGNMENTS_UPDATED",assignments:s})}};chrome.commands.onCommand.addListener((e=>{"refresh-assignments"===e&&g.syncData()}))}},s={};function a(e){var n=s[e];if(void 0!==n)return n.exports;var r=s[e]={exports:{}};return t[e](r,r.exports,a),r.exports}a.m=t,e=[],a.O=(t,s,n,r)=>{if(!s){var i=1/0;for(g=0;g<e.length;g++){for(var[s,n,r]=e[g],o=!0,c=0;c<s.length;c++)(!1&r||i>=r)&&Object.keys(a.O).every((e=>a.O[e](s[c])))?s.splice(c--,1):(o=!1,r<i&&(i=r));if(o){e.splice(g--,1);var l=n();void 0!==l&&(t=l)}}return t}r=r||0;for(var g=e.length;g>0&&e[g-1][2]>r;g--)e[g]=e[g-1];e[g]=[s,n,r]},a.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),(()=>{var e={471:0};a.O.j=t=>0===e[t];var t=(t,s)=>{var n,r,[i,o,c]=s,l=0;if(i.some((t=>0!==e[t]))){for(n in o)a.o(o,n)&&(a.m[n]=o[n]);if(c)var g=c(a)}for(t&&t(s);l<i.length;l++)r=i[l],a.o(e,r)&&e[r]&&e[r][0](),e[r]=0;return a.O(g)},s=self.webpackChunkcanvaspal=self.webpackChunkcanvaspal||[];s.forEach(t.bind(null,0)),s.push=t.bind(null,s.push.bind(s))})();var n=a.O(void 0,[225],(()=>a(429)));n=a.O(n)})();
//# sourceMappingURL=background.js.map